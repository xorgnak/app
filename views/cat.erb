
<h3 style='width: 100%; text-align: center; margin: 0; padding: 0;'>
<span><%= params['devid'] || "=^.^=" %></span>
</h3>

<code id='tty' style='width: 100%;'></code>

<textarea id='stdout' style='width: 100%; height: 80vh;'></textarea>

<h3 style='width: 100%; text-align: right; margin: 0; vertical-align: middle;'>
<input type='text' id='stdin' style='width: 85%;' placeholder=''>
<button class='material-icons' id='send' style='color: gold; font-size: large;'>send</button>
</h3>
<script>
help = "[CAT] [=|:]&lt;key&gt; [value]";
state = { devid: "<%= params['devid'] || 'sandbox' %>", name: "<%= params['name'] %>" };
macros = {};
pt = "user&sandbox> loading..."
if (state['name'] === '') {
gets = 'name'
} else {
gets = ''
}
puts = ''
function stdout(str) { $("#stdout").append(str + "\n"); console.log("STDOUT>>>", str); }
function stdlog(str) { $("#stdout").append("LOG: " + str + "\n"); console.log("LOG>>>", str); }
function stderr(str) { $("#stdout").append("ERROR: " + str + "\n"); console.log("STDERR>>>", str); }
function stdset(str) { $("#stdout").append(">>> " + str + "\n"); console.log("SET>>>", str); }
function stdin(str) { $("#stdout").append("STDIN: " + str + "\n"); console.log("STDIN>>>", str); }
function prompt() {
psid = state['name'] + "@" + state['devid'];
ps = ''
if (gets !== '') {
ps += ">>> " + gets;
} else {
ps += psid + "> ";
}
pt = ps
if (gets !== '') {
   stdset("SET: " + gets);
}
$("#stdin").attr('placeholder', ps);
}
$("#stdin").attr('placeholder', pt);
$(document).on("click", '#send', function(ev) {
ev.preventDefault();
i = $("#stdin").val();
if (i !== '') {
$("#stdin").val("");
if (gets !== '') {
   state[gets] = i
   puts += gets + ": " + state[gets] + "\n";
   gets = '';
   stdlog("STATE: " + JSON.stringify(state));
} else if (i.startsWith("=")) {
   gets = i.substring(1)
} else if (i.startsWith(":")) {
   var v = i.split(' ')
   if (v.length > 1) {
     var k = v.shift().substring(1);
     macros[k] = v;
     stdout("MACRO: " + k + ": " + v);
   } else {
     $("#stdin").val(macros[v[0].substring(1)])
   }
} else {
  stdin(i)
}
if (puts !== '') {
stdout(puts);
puts = ''
}
}
prompt();
});
$("#stdin").attr('placeholder', pt);
stdout("[CAT] loaded at <%= Time.now.utc %>");
stdout("[CAT] a simple device manager.");
stdout("[CAT] inspired by my cat. (c) 2023")
stdout(help);
prompt();
</script>